import{r as s,f as h,j as e}from"./index-BlCxgRmJ.js";import{S as I}from"./Sidebar-Gcre9kAW.js";import"./useI18n-BzDKbdEV.js";import"./index-fENnYS2p.js";function M(){const[d,m]=s.useState([]),[S,j]=s.useState(!1),[a,v]=s.useState("all"),[y,p]=s.useState(null),[o,N]=s.useState(1),[u,k]=s.useState(null),[A,f]=s.useState(!1),[C,R]=s.useState(0),x=s.useRef(null),w=s.useRef(null),c=s.useCallback(async(t=a,i=o)=>{j(!0);try{const l=`/api/reviews/admin?status=${encodeURIComponent(t)}&limit=10&page=${i}`,n=await(await h(l,{credentials:"include"})).json();m(Array.isArray(n.reviews)?n.reviews:[]),k(typeof n.totalCount=="number"?n.totalCount:null)}catch(r){console.error("Failed to load reviews",r),m([])}finally{j(!1)}},[a,o]);s.useEffect(()=>{c(a)},[a,c]),s.useEffect(()=>{const t=async()=>{try{const r=await h(`/api/reviews/admin?status=${encodeURIComponent(a)}`,{credentials:"include"});if(!r.ok)return;const l=await r.json(),n=(Array.isArray(l.reviews)?l.reviews:l).filter($=>!$.approved).length,g=x.current;if(g===null){x.current=n;return}n>g&&(R(n-g),f(!0))}catch{}},i=window.setTimeout(()=>{t()},1500);return w.current=window.setInterval(()=>{t()},3e4),()=>{clearTimeout(i),w.current!=null&&clearInterval(w.current)}},[a]);const E=async(t,i)=>{try{const r=await h(`/api/reviews/${encodeURIComponent(t)}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({approved:!i})});if(!r.ok)throw new Error("Failed");const l=await r.json();m(b=>b.map(n=>n.id===t&&l.review||n)),p(i?"Avis retiré.":"Avis approuvé."),window.setTimeout(()=>p(null),3e3)}catch(r){console.error(r),alert("Impossible de modifier l'avis")}},T=async t=>{if(confirm("Supprimer cet avis ?"))try{if(!(await h(`/api/reviews/${encodeURIComponent(t)}`,{method:"DELETE",credentials:"include"})).ok)throw new Error("Failed");m(r=>r.filter(l=>l.id!==t)),p("Avis supprimé."),window.setTimeout(()=>p(null),3e3)}catch(i){console.error(i),alert("Impossible de supprimer l'avis")}};return e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col md:flex-row",children:[e.jsx(I,{}),e.jsxs("main",{className:"flex-1 flex flex-col items-center py-4 px-2 md:py-8 md:px-4 md:ml-64",children:[y&&e.jsx("div",{className:"fixed right-6 top-6 z-50",children:e.jsx("div",{className:"bg-green-600 text-white px-4 py-2 rounded shadow",children:y})}),e.jsxs("div",{className:"w-full max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4 w-full",children:[e.jsx("div",{className:"self-start md:self-auto",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Gestion des avis"})}),e.jsx("div",{className:"flex-1 text-center min-w-0",children:e.jsx("p",{className:"text-sm text-gray-600",children:"Seuls les administrateurs peuvent approuver ou supprimer les avis."})}),e.jsx("div",{className:"w-24 md:w-32"})]}),A?e.jsxs("div",{className:"mb-4 p-3 rounded bg-blue-50 border border-blue-100 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-blue-700",children:[C," nouvel",C>1?"s":""," avis en attente"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:async()=>{await c(),x.current=d.filter(t=>!t.approved).length,f(!1)},className:"px-3 py-1 rounded bg-blue-600 text-white text-sm",children:"Voir"}),e.jsx("button",{onClick:()=>{x.current=d.filter(t=>!t.approved).length,f(!1)},className:"px-3 py-1 rounded bg-transparent border border-gray-200 text-sm",children:"Ignorer"})]})]}):null,S?e.jsx("div",{children:"Chargement..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Filtrer :"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>v("all"),className:`px-3 py-1 rounded text-sm ${a==="all"?"bg-[#0b5566] text-white":"bg-white border"}`,children:"Tous"}),e.jsx("button",{onClick:()=>v("pending"),className:`px-3 py-1 rounded text-sm ${a==="pending"?"bg-[#0b5566] text-white":"bg-white border"}`,children:"En attente"}),e.jsx("button",{onClick:()=>v("approved"),className:`px-3 py-1 rounded text-sm ${a==="approved"?"bg-[#0b5566] text-white":"bg-white border"}`,children:"Publiés"})]})]}),d.length===0?e.jsx("div",{className:"text-gray-500",children:"Aucun avis."}):d.map(t=>e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:t.authorName||"Anonyme"}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date(t.createdAt).toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>E(t.id,t.approved),className:`px-3 py-1 rounded text-sm ${t.approved?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:t.approved?"Rejeter":"Approuver"}),e.jsx("button",{onClick:()=>T(t.id),className:"px-3 py-1 rounded bg-red-100 text-red-700 text-sm",children:"Supprimer"})]})]}),e.jsx("div",{className:"mt-3 text-gray-800 whitespace-pre-wrap",children:t.content}),typeof t.rating=="number"&&e.jsxs("div",{className:"mt-2 text-sm text-gray-500",children:["Note: ",t.rating,"/5"]})]},t.id)),u!==null&&u>10&&e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-4",children:[e.jsx("button",{disabled:o===1,onClick:()=>{const t=Math.max(1,o-1);N(t),c(a,t)},className:"px-3 py-1 border rounded",children:"Préc."}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",o," / ",Math.ceil((u||0)/10)]}),e.jsx("button",{disabled:o>=Math.ceil((u||0)/10),onClick:()=>{const t=o+1;N(t),c(a,t)},className:"px-3 py-1 border rounded",children:"Suiv."})]})]})]})]})]})}export{M as default};
//# sourceMappingURL=AdminReviews-aSZlqP9M.js.map
