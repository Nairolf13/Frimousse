import{a as oe,r as p,b as ge,j as e,f as v,R as se}from"./index-BlCxgRmJ.js";import{u as be}from"./useI18n-BzDKbdEV.js";function he({parent:i,color:o,parentDue:$,onChildClick:U,onEdit:P,onDelete:V,annualPerChild:B}){const H=oe(),{t:j,locale:_}=be(),K=(i.firstName&&i.lastName?`${i.firstName[0]||""}${i.lastName[0]||""}`:i.name||"U").toUpperCase().slice(0,2),[z,q]=p.useState(!1),O="https://api.monsite.fr",[L,S]=p.useState({}),[D,R]=p.useState({open:!1,url:null,childName:null}),{user:Q}=ge(),k=Q,X=!!(k&&typeof k.role=="string"&&k.role==="parent"&&k.parentId===i.id),w=i,b=String(w.phone??w.telephone??w.tel??w.mobile??""),T=String(w.email??w.mail??w.emailAddress??""),J=String(w.address??""),F=String(w.postalCode??""),s=String(w.city??""),g=async(r,c)=>{if(c){S(f=>({...f,[r]:{...f[r]||{},loading:!0}}));try{const f=new FormData;f.append("prescription",c);const y=await v(`${O}/children/${r}/prescription`,{method:"POST",credentials:"include",body:f});if(!y.ok)throw new Error("Upload failed");const C=await y.json();S(re=>({...re,[r]:{url:C.url||null,loading:!1}}))}catch(f){console.error("Upload error",f instanceof Error?f.message:String(f)),S(y=>({...y,[r]:{url:null,loading:!1}})),alert("Échec de l'upload de l'ordonnance.")}}},I=async r=>{if(confirm("Supprimer l'ordonnance pour cet enfant ?")){S(c=>({...c,[r]:{...c[r]||{},loading:!0}}));try{if(!(await v(`${O}/children/${r}/prescription`,{method:"DELETE",credentials:"include"})).ok)throw new Error("Delete failed");S(f=>({...f,[r]:{url:null,loading:!1}}))}catch(c){console.error("Delete error",c instanceof Error?c.message:String(c)),S(f=>({...f,[r]:{...f[r]||{},loading:!1}})),alert("Échec de la suppression de l'ordonnance.")}}},M=async r=>{S(c=>({...c,[r]:{...c[r]||{},loading:!0}}));try{const c=await v(`${O}/children/${r}/prescription`,{credentials:"include"});if(!c.ok){const y=await c.json().catch(()=>({}));return alert(y.message||"Aucune ordonnance disponible"),S(C=>({...C,[r]:{url:null,loading:!1}})),null}const f=await c.json();return S(y=>({...y,[r]:{url:f.url||null,loading:!1}})),f.url||null}catch(c){return console.error("Failed to open prescription",c instanceof Error?c.message:String(c)),S(f=>({...f,[r]:{...f[r]||{},loading:!1}})),alert("Erreur lors de la récupération de l'ordonnance"),null}};return e.jsxs("div",{className:`rounded-2xl shadow ${o||"bg-white"} relative flex flex-col min-h-[420px] h-full transition-transform duration-500 perspective-1000`,style:{height:"100%",perspective:"1000px"},children:[e.jsxs("div",{className:`w-full h-full transition-transform duration-500 ${z?"rotate-y-180":""}`,style:{transformStyle:"preserve-3d",position:"relative",width:"100%",height:"100%"},children:[e.jsxs("div",{className:`absolute inset-0 w-full h-full p-5 flex flex-col ${z?"opacity-0 pointer-events-none":"opacity-100"} bg-transparent`,style:{backfaceVisibility:"hidden",overflow:"hidden"},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white flex items-center justify-center text-2xl shadow border border-gray-100 font-bold text-purple-700",children:K}),e.jsx("div",{className:"truncate flex-1",children:e.jsx("div",{className:"font-semibold text-lg text-gray-900 truncate",children:i.firstName||i.lastName?`${i.firstName||""} ${i.lastName||""}`.trim():i.name||"—"})}),e.jsx("div",{className:"ml-auto text-xs font-bold bg-white text-green-600 px-3 py-1 rounded-full shadow border border-green-100",children:(()=>{const r=i.children?i.children.length:0;return _==="en"?`${r} ${r===1?"child":"children"}`:`${r} ${r>1?"enfants":"enfant"}`})()})]}),e.jsx("div",{className:"text-sm text-gray-700 mb-4",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"text-sm text-gray-600 truncate flex items-center gap-2",children:[e.jsx("span",{"aria-hidden":!0,className:`inline-block ${b?"":"text-gray-300"}`,children:"📞"}),b?e.jsx("a",{href:`tel:${b.replace(/\s+/g,"")}`,className:"text-blue-600 hover:underline touch-manipulation",title:j("parent.form.phone"),children:b}):e.jsx("span",{className:"text-gray-400",children:"—"})]}),e.jsxs("div",{className:"text-sm text-gray-600 truncate flex items-center gap-2",children:[e.jsx("span",{"aria-hidden":!0,className:`inline-block ${T?"":"text-gray-300"}`,children:"✉️"}),T?e.jsx("a",{href:`mailto:${T}`,className:"text-blue-600 hover:underline touch-manipulation",title:j("parent.form.email"),children:T}):e.jsx("span",{className:"text-gray-400",children:"—"})]}),e.jsxs("div",{className:"text-sm text-gray-600 truncate flex items-start gap-2",children:[e.jsx("span",{"aria-hidden":!0,className:`inline-block ${J?"":"text-gray-300"}`,children:"📍"}),e.jsxs("div",{className:"leading-snug",children:[J?e.jsx("div",{className:"truncate",children:J}):e.jsx("div",{className:"text-gray-300",children:"—"}),F||s?e.jsx("div",{className:"truncate",children:[F,s].filter(Boolean).join(" ")}):e.jsx("div",{className:"text-gray-300",children:"—"})]})]})]})}),e.jsxs("div",{className:"mb-3 flex-1 overflow-auto",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:(()=>{const r=i.children?i.children.length:0;return _==="en"?r<=1?"Child":"Children":r<=1?"Enfant":"Enfants"})()}),e.jsx("div",{className:"flex flex-wrap gap-2 min-h-[120px]",children:(i.children||[]).map(r=>e.jsxs("div",{className:"bg-white rounded p-2 border w-32 h-20 flex flex-col justify-between",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("div",{className:"w-20 min-w-[5rem]",children:e.jsx("button",{onClick:()=>{U?U(r.child):H(`/parent/child/${r.child.id}/reports`)},className:"text-left text-sm font-medium text-blue-700 hover:underline w-full text-ellipsis overflow-hidden block","aria-label":`Voir les rapports de ${r.child.name}`,children:e.jsx("div",{className:"truncate",children:e.jsxs("div",{className:"truncate flex items-baseline gap-1",children:[e.jsx("span",{className:"truncate",children:r.child.name}),r.child.group?e.jsxs("span",{className:"text-xs text-gray-500",children:["(",r.child.group,")"]}):null]})})})})}),e.jsx("div",{className:"mt-1 min-h-[18px] flex items-center",children:(()=>{const c=r.child.prescriptionUrl||L[r.child.id]&&L[r.child.id].url;return X||!!c?e.jsx("button",{onClick:async()=>{let C=L[r.child.id]&&L[r.child.id].url||r.child.prescriptionUrl||null;C||(C=await M(r.child.id)),C&&R({open:!0,url:C,childName:r.child.name})},className:"text-xs text-green-700",children:j("children.prescription.view_button")}):e.jsx("div",{className:"w-full h-4","aria-hidden":!0})})()}),e.jsx("div",{className:"mt-0 flex items-center gap-1 justify-end",children:X?e.jsxs(e.Fragment,{children:[e.jsx("input",{id:`presc-${r.child.id}`,type:"file",accept:"image/*,.pdf",className:"hidden",onChange:async c=>{const f=c.target.files?c.target.files[0]:null;await g(r.child.id,f),c.target.value=""}}),e.jsx("label",{htmlFor:`presc-${r.child.id}`,className:"text-xs bg-[#0b5566] text-white px-2 py-1 rounded cursor-pointer",children:j("parent.prescription.upload")}),L[r.child.id]&&L[r.child.id].url?e.jsx("button",{onClick:()=>I(r.child.id),className:"text-xs bg-red-100 text-red-700 px-2 py-1 rounded",children:j("parent.prescription.delete")}):null]}):null})]},r.child.id))})]}),e.jsxs("div",{className:"flex-1 flex flex-col justify-end",children:[e.jsxs("div",{className:"text-sm text-gray-700 mb-3 text-center",children:[e.jsxs("div",{className:"mb-1",children:[j("parent.cotisation.this_month"),": ",e.jsxs("span",{className:"font-bold text-blue-700",children:[$||0,"€"]})]}),e.jsxs("div",{className:"text-xs",children:[j("parent.cotisation.annual_total"),": ",e.jsxs("span",{className:"font-bold text-gray-900",children:[(i.children?.length||0)*(B??15),"€"]})]})]}),e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("button",{onClick:()=>{P&&P(i)},className:"bg-white border border-gray-200 text-gray-500 hover:text-yellow-500 rounded-full p-2 shadow-sm touch-manipulation min-w-[40px] min-h-[40px] flex items-center justify-center",title:j("children.action.edit"),children:e.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15.232 5.232l3.536 3.536M9 13l6-6 3 3-6 6H9v-3z"})})}),e.jsx("button",{onClick:()=>q(!0),className:"bg-white border border-gray-200 text-gray-500 hover:text-red-500 rounded-full p-2 shadow-sm touch-manipulation min-w-[40px] min-h-[40px] flex items-center justify-center",title:j("children.action.delete"),children:e.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})})})]})]})]}),e.jsxs("div",{className:`absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-white rounded-2xl shadow-xl p-8 ${z?"opacity-100":"opacity-0 pointer-events-none"}`,style:{backfaceVisibility:"hidden",transform:"rotateY(180deg)"},children:[e.jsx("div",{className:"text-red-500 text-4xl mb-2",children:"🗑️"}),e.jsx("div",{className:"text-lg font-semibold mb-2 text-gray-900 text-center",children:j("modal.delete.title")}),e.jsx("div",{className:"text-gray-500 mb-6 text-center",children:j("parent.delete.confirm_body")}),e.jsxs("div",{className:"flex gap-3 w-full",children:[e.jsx("button",{onClick:()=>q(!1),className:"flex-1 bg-gray-100 text-gray-700 rounded-lg px-4 py-2 font-medium hover:bg-gray-200 transition",children:j("modal.cancel")}),e.jsx("button",{onClick:()=>{V&&V(String(i.id))},className:"flex-1 bg-red-500 text-white rounded-lg px-4 py-2 font-medium hover:bg-red-600 transition",children:j("children.action.delete")})]})]})]}),D.open&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-4 w-full max-w-2xl relative mx-4",children:[e.jsx("button",{onClick:()=>R({open:!1,url:null}),className:"absolute top-3 right-3 text-gray-500",children:"×"}),e.jsxs("div",{className:"text-lg font-bold mb-2",children:["Ordonnance de ",D.childName||"cet enfant"]}),e.jsx("div",{className:"w-full h-[50vh] sm:h-[70vh] flex items-center justify-center overflow-auto",children:D.url&&D.url.endsWith(".pdf")?e.jsx("iframe",{src:D.url,className:"w-full h-full",title:"Ordonnance PDF"}):e.jsx("img",{src:D.url||"",alt:"Ordonnance",className:"h-full w-auto object-contain"})})]})})]})}function fe({child:i,onClose:o}){const $=oe(),U=p.useRef(null);return p.useEffect(()=>{if(!i)return;const P=V=>{V.key==="Escape"&&o()};return document.addEventListener("keydown",P),setTimeout(()=>U.current?.focus(),0),()=>document.removeEventListener("keydown",P)},[i,o]),i?e.jsx("div",{className:"fixed inset-0 z-50 bg-white/40 backdrop-blur-[2px] flex items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"child-options-title",children:e.jsxs("div",{className:"bg-blue-50 rounded-2xl shadow-lg p-6 w-full max-w-md relative border border-blue-100",children:[e.jsx("button",{onClick:o,className:"absolute top-3 right-3 text-gray-500 hover:text-[#08323a]","aria-label":"Fermer",children:"✕"}),e.jsx("h3",{id:"child-options-title",className:"text-xl font-semibold mb-2 text-[#08323a]",children:i.name}),e.jsx("p",{className:"text-sm text-[#08323a] mb-4",children:"Que voulez-vous faire pour cet enfant ?"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{ref:U,className:"flex-1 bg-[#f7f4d7] border border-[#a9ddf2] rounded-xl px-4 py-2 hover:bg-[#fffdf6] text-[#0b5566] font-semibold",onClick:()=>{o(),$(`/parent/child/${i.id}/schedule`)},children:"Voir le planning"}),e.jsx("button",{className:"flex-1 bg-[#0b5566] text-white rounded-xl px-4 py-2 hover:bg-[#08323a] font-semibold",onClick:()=>{o(),$(`/parent/child/${i.id}/reports`)},children:"Voir les rapports"})]})]})}):null}const Se=()=>{const{user:i}=ge(),{t:o}=be(),[$,U]=p.useState(!1);p.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const n=window.matchMedia("(max-height: 600px) and (orientation: landscape)"),a=()=>U(!!n.matches);return a(),typeof n.addEventListener=="function"?n.addEventListener("change",a):n.addListener(a),window.addEventListener("resize",a),window.addEventListener("orientationchange",a),()=>{try{typeof n.removeEventListener=="function"?n.removeEventListener("change",a):n.removeListener(a)}catch{}window.removeEventListener("resize",a),window.removeEventListener("orientationchange",a)}},[]);const P=i,V=n=>{if(!n)return!1;const a=(n.role||"").toLowerCase();return a==="admin"||!!n.nannyId||a.includes("super")},[B,H]=p.useState([]),[j,_]=p.useState(!0),[K,z]=p.useState(null),[q,O]=p.useState(null),[L,S]=p.useState({}),[D,R]=p.useState(null),[Q,k]=p.useState(!1),[X,w]=p.useState(!1),[b,T]=p.useState(null),[J,F]=p.useState(null),[s,g]=p.useState({firstName:"",lastName:"",email:"",phone:"",password:"",confirmPassword:"",address:"",postalCode:"",city:"",region:"",country:""}),[I,M]=p.useState([]),[r,c]=p.useState(!1),[f,y]=p.useState(null),[C,re]=p.useState(null),W=se.useRef(null),de=se.useCallback(async n=>{if(!(C&&Date.now()<C)){if(!n||n.length<3){M([]),y(null);return}try{y(null);const a=await fetch(`/api/geodata/positionstack?q=${encodeURIComponent(n)}&limit=12`);if(a.status===422){M([]),y("Tapez au moins 3 caractères pour obtenir des suggestions");return}if(a.status===429){re(Date.now()+6e4),M([]),y("Trop de requêtes vers le service d’adresses — réessayez dans 1 minute");return}if(!a.ok){M([]),y("Impossible de récupérer les suggestions");return}const m=(await a.json()||[]).filter(h=>!!(h.house_number||h.street));M(m)}catch(a){console.error("geodata fetch error",a),M([]),y("Erreur réseau lors de la recherche d’adresse")}}},[C]);se.useEffect(()=>{const n=(s.address||s.city||"").trim();return W.current&&window.clearTimeout(W.current),W.current=window.setTimeout(()=>{const a=s.city?` ${s.city}`:"";de(`${n}${a}`.trim())},600),()=>{W.current&&window.clearTimeout(W.current)}},[s.address,s.city,de]),se.useEffect(()=>{const n=a=>{const t=a.target;if(!t)return;const l=document.querySelector("#parent-form-address");l&&l.contains(t)||c(!1)};return document.addEventListener("click",n),()=>document.removeEventListener("click",n)},[]);const we=n=>{const a=n.house_number?String(n.house_number).trim():"",t=n.street?String(n.street).trim():"",m=(a?`${a} ${t}`.trim():t||"")||n.name||"",h=String(s.address||"").trim();let d=m;if(!a){const u=h.match(/^(\d+)\s+(.+)$/);if(u&&u[1]){const x=u[1];m.startsWith(x+" ")||(d=`${x} ${m}`.trim())}}g({...s,address:d,city:n.city||"",postalCode:n.postcode||"",region:n.state||"",country:n.country||""}),M([]),c(!1)},[ce,A]=p.useState(null),[me,ye]=p.useState(null),[ue,Z]=p.useState(null),[ae,ee]=p.useState(null),[te,xe]=p.useState(!1),pe=oe();p.useEffect(()=>{(async()=>{_(!0),z(null);try{if(V(P)){const a=await v("api/parent/admin",{credentials:"include"}),t=await a.text();let l=null;try{l=t?JSON.parse(t):null}catch{l=t}if(!a.ok){if(a.status===403){const h=await v("api/parent/children",{credentials:"include"}),d=await h.text();let u=null;try{u=d?JSON.parse(d):null}catch{u=d}if(!h.ok){const x=typeof u=="string"?u:u&&typeof u=="object"&&"error"in u?String(u.error):"Erreur serveur";throw new Error(x)}H(u),_(!1);return}const m=typeof l=="string"?l:l&&typeof l=="object"&&"error"in l?String(l.error):"Erreur serveur";throw new Error(m)}O(l);try{const m=new Date,h=`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}`,d=await v(`api/parent/billing?month=${h}`,{credentials:"include"});if(d.ok){const u=await d.json();S(u||{})}}catch{}}else{const a=await v("api/parent/children",{credentials:"include"}),t=await a.text();let l=null;try{l=t?JSON.parse(t):null}catch{l=t}if(!a.ok){const h=typeof l=="string"?l:l&&typeof l=="object"&&"error"in l?String(l.error):"Erreur serveur";throw new Error(h)}H(l||[]);try{const h=new Date,d=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}`,u=await v(`api/parent/billing?month=${d}`,{credentials:"include"});if(u.ok){const x=await u.json();S(x||{})}}catch{}}}catch(a){console.error("ParentDashboard load error",a instanceof Error?a.message:String(a)),a instanceof Error?z(a.message):z("Erreur")}finally{_(!1)}})()},[P,i]);const E=i??null,ne=E?{id:E.parentId??E.id??"me",name:E.name??`${E.firstName??""} ${E.lastName??""}`.trim()??null,firstName:E.firstName??null,lastName:E.lastName??null,email:E.email??null,phone:E.phone??null,children:B.map(n=>({child:n}))}:null;if(j)return e.jsx("div",{className:"p-6",children:o("loading")});if(K)return e.jsxs("div",{className:"p-6 text-red-600",children:[o("global.error")||"Erreur",": ",K]});if(V(P)){const n=q?.stats??{parentsCount:0},a=q?.parents??[];return e.jsx("div",{className:`relative z-0 min-h-screen bg-[#fcfcff] p-4 ${$?"":"md:pl-64"} w-full`,children:e.jsxs("div",{className:"max-w-7xl mx-auto w-full",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 w-full",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-extrabold mb-1 tracking-tight",style:{color:"#0b5566"},children:o("page.parent")}),e.jsx("div",{className:"text-base md:text-lg font-medium mb-4 md:mb-6",style:{color:"#08323a"},children:o("page.parent.description")})]}),e.jsx("div",{className:"flex gap-2 items-center",children:i&&typeof i.role=="string"&&(i.role.toLowerCase()==="admin"||i.role.toLowerCase().includes("super")||i.nannyId==null)&&e.jsx("button",{onClick:()=>{w(!0),A(null),g({firstName:"",lastName:"",email:"",phone:"",password:"",confirmPassword:"",address:"",postalCode:"",city:"",region:"",country:""})},className:`bg-[#0b5566] text-white font-semibold rounded-lg px-5 py-2 text-base shadow hover:bg-[#08323a] transition min-h-[44px] md:h-[60px] flex items-center ${$?"-translate-x-3":""}`,style:{transform:$?"translateX(-12px)":void 0},children:o("parent.add")})})]}),e.jsxs("div",{className:"flex flex-col md:items-start gap-3 mb-6 w-full",children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"flex gap-2 items-center flex-wrap w-full",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow px-3 py-2 md:px-4 md:py-2 flex flex-col items-center min-w-[80px] md:min-w-[90px] min-h-[44px] md:h-[60px] justify-center flex-shrink-0",children:[e.jsx("div",{className:"text-xs text-gray-400",children:o("stats.total")}),e.jsx("div",{className:"text-lg font-bold text-gray-900",children:n.parentsCount})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow px-3 py-2 md:px-4 md:py-2 flex flex-col items-center min-w-[80px] md:min-w-[90px] min-h-[44px] md:h-[60px] justify-center flex-shrink-0",children:[e.jsx("div",{className:"text-xs text-gray-400",children:o("stats.active")}),e.jsx("div",{className:"text-lg font-bold text-gray-900",children:a.filter(t=>t.children&&t.children.length>0).length})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow px-3 py-2 md:px-4 md:py-2 flex flex-col items-center min-w-[80px] md:min-w-[90px] min-h-[44px] md:h-[60px] justify-center flex-shrink-0",children:[e.jsx("div",{className:"text-xs text-gray-400",children:o("stats.new")}),e.jsx("div",{className:"text-lg font-bold text-gray-900",children:a.filter(t=>{if(!t.createdAt)return!1;const l=new Date(t.createdAt),h=Math.abs(new Date().getTime()-l.getTime());return Math.ceil(h/(1e3*60*60*24))<=30}).length})]})]})}),e.jsx("div",{className:"w-full md:w-auto",children:e.jsx("input",{type:"text",placeholder:o("children.search_placeholder"),className:"border border-gray-200 rounded-lg px-3 py-2 text-gray-700 bg-white shadow-sm text-sm md:text-base w-full md:w-64 min-h-[44px]"})})]}),(X||b)&&e.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),A(null),!s.firstName||!s.lastName||!s.email){A("Les champs Prénom, Nom et Email sont requis");return}if((s.password||s.confirmPassword)&&s.password!==s.confirmPassword){A("Les mots de passe ne correspondent pas");return}try{const l=b?`api/parent/${b.id}`:"api/parent",m=b?"PUT":"POST",h=i&&typeof i.role=="string"&&(i.role.toLowerCase()==="admin"||i.role.toLowerCase().includes("super")),d=i,u=!!(b&&d&&String(d.parentId??d.id??"")===String(b.id)),x={name:`${s.firstName} ${s.lastName}`,email:s.email};if(s.phone&&(x.phone=s.phone),s.address&&(x.address=s.address),s.postalCode&&(x.postalCode=s.postalCode),s.city&&(x.city=s.city),s.region&&(x.region=s.region),s.country&&(x.country=s.country),b&&s.password&&h&&!u){const Y={name:String(x.name),email:String(x.email)};x.phone&&(Y.phone=String(x.phone)),Y.newPassword=s.password,ee({payload:Y,parentId:b.id}),Z({open:!0,parentId:b.id,password:s.password});return}s.password&&(b&&(h||u)?x.newPassword=s.password:b||(x.password=s.password));const N=await v(l,{method:m,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(x)});let G=null;try{G=await N.json()}catch{}if(!N.ok){const Y=typeof G=="object"&&G!==null&&"message"in G?String(G.message):await N.text();throw new Error(Y||"Erreur création parent")}ye(s.password?b?"Parent modifié.":"Parent créé avec mot de passe.":b?"Parent modifié.":"Parent créé — une invitation a été envoyée.");const le=await(await v("api/parent/admin",{credentials:"include"})).text();let ie=null;try{ie=le?JSON.parse(le):null}catch{ie=le}O(ie),w(!1),T(null),g({firstName:"",lastName:"",email:"",phone:"",password:"",confirmPassword:"",address:"",postalCode:"",city:"",region:"",country:""})}catch(l){console.error("Add parent failed",l),l instanceof Error?A(l.message):A("Erreur")}},className:"mb-6 bg-white rounded-2xl shadow p-4 md:p-6 grid gap-2 md:grid-cols-2 lg:grid-cols-3",children:[e.jsx("input",{name:"firstName",value:s.firstName,onChange:t=>g({...s,firstName:t.target.value}),placeholder:o("parent.form.firstName"),required:!0,className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsx("input",{name:"lastName",value:s.lastName,onChange:t=>g({...s,lastName:t.target.value}),placeholder:o("parent.form.lastName"),required:!0,className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsx("input",{name:"email",type:"email",value:s.email,onChange:t=>g({...s,email:t.target.value}),placeholder:o("parent.form.email"),required:!0,className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsx("input",{name:"phone",type:"tel",value:s.phone,onChange:t=>g({...s,phone:t.target.value}),placeholder:o("parent.form.phone"),className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsxs("div",{id:"parent-form-address",className:"relative",children:[e.jsx("input",{name:"address",value:s.address,onChange:t=>{g({...s,address:t.target.value}),c(!0)},onFocus:()=>c(!0),placeholder:o("parent.form.address")||"Adresse",className:"border rounded px-3 py-2 text-xs md:text-base w-full",autoComplete:"off"}),f&&e.jsx("div",{className:"text-sm text-red-500 mt-1",children:f}),r&&I&&I.length>0&&e.jsx("div",{className:"absolute z-50 bg-white shadow rounded mt-1 w-full max-h-40 overflow-auto border",children:I.map((t,l)=>e.jsxs("div",{className:"px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>we(t),children:[e.jsx("div",{className:"font-medium",children:(t.house_number?`${t.house_number} `:"")+(t.street||t.name||"")}),e.jsx("div",{className:"text-xs text-gray-500",children:[t.postcode,t.city,t.state,t.country].filter(Boolean).join(" • ")})]},l))})]}),e.jsx("input",{name:"postalCode",value:s.postalCode,onChange:t=>g({...s,postalCode:t.target.value}),placeholder:o("parent.form.postalCode")||"Code postal",className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsx("input",{name:"city",value:s.city,onChange:t=>g({...s,city:t.target.value}),placeholder:o("parent.form.city")||"Ville",className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsx("input",{name:"region",value:s.region,onChange:t=>g({...s,region:t.target.value}),placeholder:o("parent.form.region")||"Région",className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsx("input",{name:"country",value:s.country,onChange:t=>g({...s,country:t.target.value}),placeholder:o("parent.form.country")||"Pays",className:"border rounded px-3 py-2 text-xs md:text-base"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{name:"password",type:te?"text":"password",value:s.password,onChange:t=>g({...s,password:t.target.value}),placeholder:o("parent.form.password.placeholder"),className:"border rounded px-3 py-2 text-xs md:text-base w-full pr-10"}),e.jsx("button",{type:"button",tabIndex:-1,className:"absolute right-2 top-2 text-gray-400 hover:text-gray-700",onClick:()=>xe(t=>!t),children:te?"🙈":"👁️"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{name:"confirmPassword",type:te?"text":"password",value:s.confirmPassword,onChange:t=>g({...s,confirmPassword:t.target.value}),placeholder:o("parent.form.confirmPassword.placeholder"),className:"border rounded px-3 py-2 text-xs md:text-base w-full pr-10"}),e.jsx("button",{type:"button",tabIndex:-1,className:"absolute right-2 top-2 text-gray-400 hover:text-gray-700",onClick:()=>xe(t=>!t),children:te?"🙈":"👁️"})]}),e.jsxs("div",{className:"md:col-span-2 flex gap-2",children:[e.jsx("button",{type:"submit",className:"bg-[#0b5566] text-white px-4 py-2 rounded hover:bg-[#08323a] transition",children:o(b?"parent.form.submit.save":"parent.form.submit.add")}),e.jsx("button",{type:"button",onClick:()=>{w(!1),T(null),g({firstName:"",lastName:"",email:"",phone:"",password:"",confirmPassword:"",address:"",postalCode:"",city:"",region:"",country:""}),A(null)},className:"bg-gray-300 px-4 py-2 rounded",children:o("parent.form.cancel")})]}),ce&&e.jsx("div",{className:"text-red-600 md:col-span-2",children:ce}),me&&e.jsx("div",{className:"md:col-span-2 text-[#0b5566] font-semibold text-center bg-[#a9ddf2] border border-[#fcdcdf] rounded-lg py-2",children:me})]}),e.jsx("div",{children:e.jsx("div",{className:"grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 auto-rows-fr items-stretch w-full",children:(()=>{const t=["bg-blue-50","bg-yellow-50","bg-purple-50","bg-[#a9ddf2]","bg-pink-50","bg-orange-50"];return a.map((l,m)=>{const h=t[m%t.length];return e.jsx(he,{parent:l,color:h,parentDue:L[String(l.id)]||0,onChildClick:d=>{R(d),k(!0)},onEdit:async d=>{T(d),w(!1),A(null),g({firstName:d.firstName||"",lastName:d.lastName||"",email:d.email||"",phone:d.phone||"",address:"",postalCode:"",city:"",region:"",country:"",password:"",confirmPassword:""}),window.scrollTo({top:0,behavior:"smooth"});try{if((!d.email||!d.phone)&&d.id){const u=await v(`api/parent/${d.id}`,{credentials:"include"});if(u.ok){const x=await u.json(),N=x&&typeof x=="object"&&"parent"in x?x.parent:x;N&&g({firstName:String(N.firstName??N.name??""),lastName:String(N.lastName??""),email:String(N.email??""),phone:String(N.phone??""),address:String(N.address??""),postalCode:String(N.postalCode??""),city:String(N.city??""),region:String(N.region??""),country:String(N.country??""),password:"",confirmPassword:""})}}}catch{}},onDelete:d=>{F(d)}},l.id)})})()})}),J&&e.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("div",{className:"text-lg font-semibold mb-4 text-gray-900",children:o("modal.delete.title")}),e.jsx("div",{className:"text-sm text-gray-600 mb-4",children:o("parent.delete.confirm_body")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>F(null),className:"flex-1 bg-gray-100 text-gray-700 rounded-lg px-4 py-2",children:o("modal.cancel")}),e.jsx("button",{onClick:async()=>{try{const t=await v(`api/parent/${J}`,{method:"DELETE",credentials:"include"}),l=await t.text();let m=null;try{m=l?JSON.parse(l):null}catch{m=l}if(!t.ok){const x=m&&typeof m=="object"&&("message"in m||"error"in m)?m.message||m.error:typeof m=="string"?m:"Erreur suppression";throw new Error(String(x))}const d=await(await v("api/parent/admin",{credentials:"include"})).text();let u=null;try{u=d?JSON.parse(d):null}catch{u=d}O(u),F(null)}catch(t){console.error("Delete parent failed",t),t instanceof Error?alert("Suppression échouée: "+t.message):alert("Suppression échouée"),F(null)}},className:"flex-1 bg-red-500 text-white rounded-lg px-4 py-2",children:o("children.action.delete")})]})]})}),Q&&e.jsx(fe,{child:D,onClose:()=>{k(!1),R(null)}}),ue&&ue.open&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6 w-full max-w-md",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Confirmer la réinitialisation du mot de passe"}),e.jsx("p",{className:"mb-4",children:"Vous allez réinitialiser le mot de passe de ce parent. Voulez-vous continuer ?"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{ee(null),Z(null)},className:"flex-1 bg-gray-100 text-gray-700 rounded-lg px-4 py-2",children:"Annuler"}),e.jsx("button",{onClick:async()=>{if(ae)try{if(!(await v(`api/parent/${ae.parentId}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(ae.payload)})).ok)throw new Error("Erreur lors de la mise à jour");const m=await(await v("api/parent/admin",{credentials:"include"})).text();let h=null;try{h=m?JSON.parse(m):null}catch{h=m}O(h),ee(null),Z(null),T(null),w(!1),g({firstName:"",lastName:"",email:"",phone:"",password:"",confirmPassword:"",address:"",postalCode:"",city:"",region:"",country:""})}catch(t){console.error("Parent reset failed",t),ee(null),Z(null),A("La réinitialisation a échoué")}},className:"flex-1 bg-blue-600 text-white rounded-lg px-4 py-2",children:"Confirmer"})]})]})})]})})}return e.jsxs("div",{className:`min-h-screen bg-[#fcfcff] p-2 sm:p-4 ${$?"":"md:pl-64"} w-full`,children:[e.jsxs("div",{className:"max-w-7xl mx-auto w-full px-0 sm:px-2 md:px-4",children:[e.jsx("h1",{className:"text-2xl font-semibold mb-4",children:"Espace Parent"}),ne?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx(he,{parent:ne,color:"bg-white",parentDue:L[String(ne.id)]||0,onChildClick:n=>{R(n),k(!0)},onEdit:void 0,onDelete:void 0,annualPerChild:15})}):B.length===0?e.jsx("div",{children:"Aucun enfant trouvé."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:B.map(n=>e.jsx("div",{className:"p-4 border rounded shadow-sm",style:{borderColor:"#fcdcdf"},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("button",{type:"button",className:"font-medium cursor-pointer text-[#08323a] hover:text-[#0b5566] text-left",onClick:a=>{a.stopPropagation(),R(n),k(!0)},children:n.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Groupe: ",n.group]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"btn bg-[#a9ddf2] text-[#0b5566] hover:bg-[#f7f4d7]",onClick:()=>pe(`/parent/child/${n.id}/schedule`),children:"Planning"}),e.jsx("button",{className:"btn bg-[#a9ddf2] text-[#0b5566] hover:bg-[#f7f4d7]",onClick:()=>pe(`/parent/child/${n.id}/reports`),children:"Rapports"})]})]})},n.id))})]}),Q&&e.jsx(fe,{child:D,onClose:()=>{k(!1),R(null)}})]})};export{Se as default};
//# sourceMappingURL=ParentDashboard-g40jhNA6.js.map
