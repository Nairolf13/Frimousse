import{r as n,j as t}from"./index-BlCxgRmJ.js";const F="https://api.monsite.fr";function je(){const Z=e=>{if(!e||typeof e!="object")return null;try{const s=e,o=s.country_code||s.country_code;return o?String(o).toUpperCase():null}catch(s){return console.error("getRawCountryCode error",s),null}},[a,ee]=n.useState({email:"",password:"",name:"",role:"admin",centerName:"",address:"",city:"",postalCode:"",region:"",country:""}),[D,te]=n.useState(""),[E,se]=n.useState(!1),[P,oe]=n.useState(!1),[M,S]=n.useState(""),[re,ne]=n.useState(!1),[p,ae]=n.useState([]),[J,$]=n.useState([]),[R,w]=n.useState(null),[V,j]=n.useState([]),[B,v]=n.useState([]),[G,N]=n.useState([]),[le,T]=n.useState(!1),[ce,L]=n.useState(!1),[ie,A]=n.useState(!1),[de,q]=n.useState(!1),g=n.useRef(null),I=n.useRef(null),b=e=>ee(s=>({...s,...e})),O=(e,s)=>{b({[e]:s}),setTimeout(()=>{try{const o=document.querySelector(`input[name="${e}"]`);if(o){o.focus();const r=o.value?o.value.length:0;o.setSelectionRange(r,r)}}catch(o){console.error("applyAndFocus error:",o)}},0)},x=e=>{if(e.target.name==="role")return;const s=e.target.name,o=e.target.value;b({[s]:o}),console.debug("[geodata] handleChange",s,o),s==="country"&&(T(!0),console.debug("[geodata] openCountry")),s==="region"&&(L(!0),console.debug("[geodata] openRegion")),s==="city"&&(A(!0),console.debug("[geodata] openCity")),s==="address"&&(q(!0),console.debug("[geodata] openAddress"))};n.useEffect(()=>{(async()=>{try{const e=await fetch("/api/geodata/countries");if(!e.ok)return;const s=await e.json();ae(s||[])}catch(e){console.error("Failed to load countries",e)}})()},[]),n.useEffect(()=>{if(!a.country){$([]),w(null);return}const e=a.country.toLowerCase(),s=p.filter(r=>r.name&&r.name.toLowerCase().includes(e)).slice(0,8).map(r=>({name:r.name}));$(s);const o=p.find(r=>r.name===a.country)||p.find(r=>r.name&&r.name.toLowerCase()===e);if(o&&o.cca2)w(String(o.cca2).toUpperCase());else{const r=p.filter(l=>l.name&&l.name.toLowerCase().includes(e));if(r.length===1&&r[0].cca2)w(String(r[0].cca2).toUpperCase());else{const l=p.find(m=>m.name&&m.name.toLowerCase().startsWith(e));w(l&&l.cca2?String(l.cca2).toUpperCase():null)}}},[a.country,p]);const W=n.useCallback(async e=>{if(console.debug("[geodata] fetchGeodata query=",e),!e||e.length<2){v([]),N([]);return}try{const s=await fetch(`/api/geodata/positionstack?q=${encodeURIComponent(e)}&limit=12`);if(console.debug("[geodata] backend status",s.status),!s.ok){v([]),N([]);return}const o=await s.json();console.debug("[geodata] backend returned",Array.isArray(o)?o.length:typeof o);const r=o||[],l=r.filter(i=>{const c=!!(i.city||i.name&&!i.street&&!i.house_number),d=!!(i.house_number||i.street);return c&&!d}),m=r.filter(i=>!!(i.house_number||i.street));N(l),v(m)}catch(s){console.error("geodata fetch error",s),v([]),N([])}},[]);n.useEffect(()=>{const e=(a.address||a.city||"").trim();return g.current&&window.clearTimeout(g.current),g.current=window.setTimeout(()=>{const s=a.city?` ${a.city}`:"";W(`${e}${s}`.trim())},1e3),()=>{g.current&&window.clearTimeout(g.current)}},[a.address,a.city,W]),n.useEffect(()=>{const e=(a.region||"").trim();return g.current&&window.clearTimeout(g.current),g.current=window.setTimeout(async()=>{if(console.debug("[geodata] region lookup q=",e),!e||e.length<2)return j([]);try{const s=await fetch(`/api/geodata/positionstack?q=${encodeURIComponent(e)}&limit=40`);if(!s.ok)return j([]);const o=await s.json(),r=new Set,l=[],m=R?R.toUpperCase():null;for(const i of o||[]){const c=i.state||null,d=Z(i.raw);if(!c||m&&d&&d!==m)continue;const f=String(c);if(!r.has(f)&&(r.add(f),l.push(f),l.length>=8))break}j(l)}catch(s){console.error("region geodata error",s),j([])}},1e3),()=>{g.current&&window.clearTimeout(g.current)}},[a.region,R]),n.useEffect(()=>{const e=s=>{I.current&&(I.current.contains(s.target)||(T(!1),L(!1),A(!1),q(!1)))};return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]);const[u,_]=n.useState("decouverte"),[U,C]=n.useState(!1),[z]=n.useState(!1),[ue,H]=n.useState(!1),[me,fe]=n.useState(""),ge=async e=>{if(e.preventDefault(),S(""),ne(!1),a.password!==D){S("Les mots de passe ne correspondent pas.");return}try{if(u==="decouverte"){C(!0);const c=await fetch(`${F}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({...a,plan:u})}),d=await c.json().catch(()=>({}));if(!c.ok)throw new Error(d?.message||d?.error||"Erreur lors de l'inscription");const f=await fetch(`${F}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:a.email,password:a.password})});if(f.status===402){const k=await f.json().catch(()=>({}));fe(k?.error||"Votre compte nécessite un abonnement pour continuer."),H(!0),C(!1);return}const h=await f.json().catch(()=>({}));if(!f.ok)throw new Error(h?.message||h?.error||"Erreur lors de la connexion");window.location.href="/";return}C(!0);const s=await fetch(`${F}/auth/register-subscribe/init`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({...a,plan:u})}),o=await s.json();if(!s.ok)throw new Error(o?.message||o?.error||"Erreur lors de l’inscription");const r="/api/subscriptions/create-checkout-with-token",l={plan:u,mode:"direct",subscribeToken:o.subscribeToken},m=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),i=await m.json().catch(()=>({}));if(!m.ok||!i.url)throw new Error(i.error||"Impossible de créer la session de paiement");window.location.href=i.url}catch(s){s instanceof Error?S(s.message||"Erreur lors de l’inscription"):S("Erreur lors de l’inscription"),C(!1)}finally{C(!1)}},he=e=>{b({country:e});const s=p.find(o=>o.name===e||o.name&&o.name.toLowerCase()===e.toLowerCase());w(s&&s.cca2?String(s.cca2).toUpperCase():null),$([]),T(!1),O("region","")},xe=e=>{b({region:e}),j([]),L(!1),O("city","")},pe=e=>{const s=e.house_number?String(e.house_number).trim():"",o=e.street?String(e.street).trim():"",l=(s?`${s} ${o}`.trim():o||"")||e.name||"",m=String(a.address||"").trim();let i=l;if(!s){const c=m.match(/^(\d+)\s+(.+)$/);if(c&&c[1]){const d=c[1];l.startsWith(d+" ")||(i=`${d} ${l}`.trim())}}b({address:i,city:e.city||"",postalCode:e.postcode||"",region:e.state||"",country:e.country||""}),(async()=>{try{if(!e.postcode||!e.city||!e.house_number){const c=encodeURIComponent(e.name||l||"");if(!c)return;const d=await fetch(`/api/geodata/positionstack?q=${c}&limit=1`);if(!d.ok)return;const f=await d.json();if(!f||f.length===0)return;const h=f[0],k=h.city||"",K=h.postcode||"",Q=h.state||"",X=h.country||"",Y=h.house_number||"",be=h.street||"",y={};if(!e.city&&k&&(y.city=k),!e.postcode&&K&&(y.postalCode=K),!e.state&&Q&&(y.region=Q),!e.country&&X&&(y.country=X),!s&&Y){const ye=o||be||h.name||"";y.address=`${Y} ${ye}`.trim()}Object.keys(y).length>0&&b(y)}}catch(c){console.error("selectPlace followup lookup error",c)}})(),v([]),q(!1),setTimeout(()=>{try{const c=document.querySelector('input[name="postalCode"]');if(c){c.focus();const d=c.value?c.value.length:0;c.setSelectionRange(d,d)}}catch(c){console.error("focus postalCode error",c)}},0)};return t.jsxs("div",{ref:I,className:"h-screen flex items-center justify-center bg-gradient-to-r from-[#f7f4d7] to-[#a9ddf2] overflow-hidden",children:[t.jsxs("form",{onSubmit:ge,className:"bg-white rounded-2xl shadow-lg p-6 w-full max-w-xl md:max-w-2xl flex flex-col items-center max-h-[95vh] overflow-auto",children:[t.jsx("div",{className:"w-20 h-20 mb-4",children:t.jsx("img",{src:"/imgs/LogoFrimousse.webp",alt:"Logo",className:"w-full h-full object-contain"})}),t.jsx("h2",{className:"text-2xl font-bold mb-2 text-[#0b5566] text-center",children:"Inscription"}),t.jsx("p",{className:"mb-6 text-[#08323a] text-center",children:"Créez votre compte Frimousse"}),M&&t.jsx("div",{className:"mb-4 text-red-600 w-full text-center",children:M}),re&&t.jsx("div",{className:"mb-4 text-[#0b5566] w-full text-center",children:"Inscription réussie. Redirection…"}),t.jsxs("label",{className:"block mb-3 w-full text-left font-medium text-[#08323a]",children:["Nom",t.jsx("input",{name:"name",value:a.name,onChange:x,placeholder:"Nom et prénom",required:!0,className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"})]}),t.jsxs("label",{className:"block mb-3 w-full text-left font-medium text-[#08323a]",children:["Email",t.jsx("input",{name:"email",type:"email",value:a.email,onChange:x,placeholder:"Email",required:!0,className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"})]}),t.jsxs("label",{className:"block mb-3 w-full text-left font-medium text-[#08323a]",children:["Société / Crèche",t.jsx("input",{name:"centerName",value:a.centerName,onChange:x,placeholder:"Nom de la crèche ou société",className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 w-full mb-3",children:[t.jsxs("label",{className:"block text-left font-medium text-[#08323a]",children:["Adresse",t.jsxs("div",{className:"relative",children:[t.jsx("input",{name:"address",value:a.address,onChange:x,placeholder:"Adresse ",className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"}),de&&B.length>0&&t.jsx("ul",{className:"absolute z-20 left-0 right-0 bg-white border mt-1 max-h-56 overflow-auto rounded shadow",children:B.map((e,s)=>{const o=[e.house_number&&`${e.house_number} ${e.street}`,e.street||e.name,e.postcode,e.state,e.country].filter(Boolean).join(", "),r=e.name||(e.house_number?`${e.house_number} ${e.street}`:e.street||"");return t.jsxs("li",{role:"button",tabIndex:0,onClick:()=>{pe(e)},className:"px-3 py-2 hover:bg-gray-100 cursor-pointer",children:[t.jsx("div",{className:"text-sm font-medium",children:r}),t.jsx("div",{className:"text-xs text-gray-500",children:o})]},s)})})]})]}),t.jsxs("label",{className:"block text-left font-medium text-[#08323a]",children:["Pays",t.jsxs("div",{className:"relative",children:[t.jsx("input",{name:"country",value:a.country,onChange:x,placeholder:"Pays",autoComplete:"off",className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"}),le&&J.length>0&&t.jsx("ul",{className:"absolute z-20 left-0 right-0 bg-white border mt-1 max-h-44 overflow-auto rounded shadow",children:J.map((e,s)=>t.jsx("li",{role:"button",tabIndex:0,onClick:()=>he(e.name),className:"px-3 py-2 hover:bg-gray-100 cursor-pointer",children:e.name},s))})]})]}),t.jsxs("label",{className:"block text-left font-medium text-[#08323a]",children:["Région",t.jsxs("div",{className:"relative",children:[t.jsx("input",{name:"region",value:a.region,onChange:x,placeholder:"Région / Département",autoComplete:"off",className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"}),ce&&V.length>0&&t.jsx("ul",{className:"absolute z-20 left-0 right-0 bg-white border mt-1 max-h-44 overflow-auto rounded shadow",children:V.map((e,s)=>t.jsx("li",{role:"button",tabIndex:0,onClick:()=>xe(e),className:"px-3 py-2 hover:bg-gray-100 cursor-pointer",children:e},s))})]})]}),t.jsxs("label",{className:"block text-left font-medium text-[#08323a]",children:["Ville",t.jsxs("div",{className:"relative",children:[t.jsx("input",{name:"city",value:a.city,onChange:x,placeholder:"Ville",autoComplete:"off",className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"}),ie&&G.length>0&&t.jsx("ul",{className:"absolute z-20 left-0 right-0 bg-white border mt-1 max-h-56 overflow-auto rounded shadow",children:G.map((e,s)=>{const o=e.city||e.name||"",r=[e.postcode,e.state,e.country].filter(Boolean).join(", ");return t.jsxs("li",{role:"button",tabIndex:0,onClick:()=>{const l={city:o};e.postcode&&(l.postalCode=String(e.postcode)),e.state&&(l.region=String(e.state)),e.country&&(l.country=String(e.country)),b(l),N([]),A(!1),O("address","")},className:"px-3 py-2 hover:bg-gray-100 cursor-pointer",children:[t.jsx("div",{className:"text-sm font-medium",children:o}),t.jsx("div",{className:"text-xs text-gray-500",children:r})]},s)})})]})]})]}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 w-full mb-3",children:t.jsxs("label",{className:"block text-left font-medium text-[#08323a]",children:["Code postal",t.jsx("input",{name:"postalCode",value:a.postalCode,onChange:x,placeholder:"Code postal",className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2]"})]})}),t.jsxs("label",{className:"block mb-3 w-full text-left font-medium text-gray-700",children:["Mot de passe",t.jsxs("div",{className:"relative",children:[t.jsx("input",{name:"password",type:E?"text":"password",value:a.password,onChange:x,placeholder:"Mot de passe",required:!0,className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2] pr-10"}),t.jsx("button",{type:"button",tabIndex:-1,"aria-label":E?"Masquer le mot de passe":"Afficher le mot de passe",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-[#0b5566] text-lg focus:outline-none",onClick:()=>se(e=>!e),children:E?"🙈":"👁️"})]})]}),t.jsxs("label",{className:"block mb-3 w-full text-left font-medium text-gray-700",children:["Confirmer le mot de passe",t.jsxs("div",{className:"relative",children:[t.jsx("input",{name:"confirmPassword",type:P?"text":"password",value:D,onChange:e=>te(e.target.value),placeholder:"Confirmer le mot de passe",required:!0,className:"mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a9ddf2] pr-10"}),t.jsx("button",{type:"button",tabIndex:-1,"aria-label":P?"Masquer le mot de passe":"Afficher le mot de passe",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-[#0b5566] text-lg focus:outline-none",onClick:()=>oe(e=>!e),children:P?"🙈":"👁️"})]})]}),t.jsxs("div",{className:"w-full mb-4 mt-6",children:[t.jsx("label",{className:"block mb-2 font-medium text-[#08323a]",children:"Offres"}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[t.jsxs("button",{type:"button",onClick:()=>_("decouverte"),className:`p-3 rounded-lg border text-sm focus:outline-none flex flex-col items-center text-center min-h-[140px] ${u==="decouverte"?"border-[#0b5566] bg-[#f7f4d7]":"border-gray-200 bg-white hover:shadow-sm"}`,children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold text-[#0b5566]",children:"Découverte"}),t.jsx("div",{className:"text-xs text-gray-600",children:"Essai 15 jours"})]}),t.jsx("div",{className:"mt-3 text-xs text-gray-600",children:"Tester Frimousse sans engagement"}),t.jsx("div",{className:"mt-auto text-base font-bold text-[#0b5566]",children:"0€"})]}),t.jsxs("button",{type:"button",onClick:()=>_("essentiel"),className:`p-3 rounded-lg border text-sm focus:outline-none flex flex-col items-center text-center min-h-[140px] ${u==="essentiel"?"border-[#0b5566] bg-white shadow":"border-gray-200 bg-white hover:shadow-sm"}`,children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold text-[#0b5566]",children:"Essentiel"}),t.jsx("div",{className:"text-xs text-gray-600",children:"Pour petites structures"})]}),t.jsx("div",{className:"mt-3 text-xs text-gray-600",children:"Jusqu’à 10 enfants, exports et notifications"}),t.jsxs("div",{className:"mt-auto text-base font-bold text-[#0b5566]",children:["29,99€ ",t.jsx("span",{className:"text-xs text-gray-500",children:"/ mois"})]})]}),t.jsxs("button",{type:"button",onClick:()=>_("pro"),className:`p-3 rounded-lg border text-sm focus:outline-none flex flex-col items-center text-center min-h-[140px] ${u==="pro"?"border-[#0b5566] bg-white shadow":"border-gray-200 bg-white hover:shadow-sm"}`,children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold text-[#0b5566]",children:"Pro"}),t.jsx("div",{className:"text-xs text-gray-600",children:"Pour structures avancées"})]}),t.jsx("div",{className:"mt-3 text-xs text-gray-600",children:"Enfants illimités, Assistant IA "}),t.jsxs("div",{className:"mt-auto text-base font-bold text-[#0b5566]",children:["59,99€ ",t.jsx("span",{className:"text-xs text-gray-500",children:"/ mois"})]})]})]})]}),(u==="essentiel"||u==="pro")&&t.jsx("div",{className:"w-full max-w-xl md:max-w-2xl mt-2 px-6",children:t.jsx("div",{className:"rounded-md bg-yellow-100 border-l-4 border-yellow-400 p-3 text-sm text-yellow-800",children:"Les abonnements payant ne sont pas encore disponibles veuillez essayer la version gratuite sans engagement — Contactez-nous pour plus de renseignements."})}),t.jsx("button",{type:"submit",disabled:U||z||u!=="decouverte",title:u!=="decouverte"?"Les abonnements payants ne sont pas encore disponibles. Contactez-nous pour plus d’informations.":void 0,"aria-disabled":u!=="decouverte"?"true":"false",className:`w-full py-2 rounded-full font-semibold transition focus:outline-none focus:ring-2 focus:ring-[#a9ddf2] ${U||z||u!=="decouverte"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-[#0b5566] text-white hover:opacity-95"}`,children:U||z?"Patientez…":u==="decouverte"?"S’inscrire":"S’inscrire et payer"}),t.jsxs("div",{className:"mt-4 text-sm text-[#08323a]",children:["Déjà un compte ? ",t.jsx("a",{href:"/login",className:"text-[#0b5566] hover:underline",children:"Se connecter"})]})]}),ue&&t.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50 px-4",children:t.jsxs("div",{role:"dialog","aria-modal":"true",className:"bg-white rounded-lg p-6 max-w-md w-full shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-[#0b5566] mb-2",children:"Abonnement requis"}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:me||"Cette action nécessite un abonnement. Passez à un plan supérieur pour continuer."}),t.jsxs("div",{className:"flex justify-end gap-3",children:[t.jsx("button",{onClick:()=>{window.location.href="/pricing"},className:"px-4 py-2 bg-[#0b5566] text-white rounded-md",children:"Aller aux offres"}),t.jsx("button",{onClick:()=>H(!1),className:"px-4 py-2 border rounded-md",children:"Fermer"})]})]})})]})}export{je as default};
//# sourceMappingURL=RegisterPage-D6DfyaeL.js.map
