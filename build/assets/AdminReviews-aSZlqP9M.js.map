{"version":3,"file":"AdminReviews-aSZlqP9M.js","sources":["../../pages/AdminReviews.tsx"],"sourcesContent":["import { useCallback, useEffect, useRef, useState } from 'react';\nimport Sidebar from '../components/Sidebar';\nimport { fetchWithRefresh } from '../utils/fetchWithRefresh';\n\ntype Review = {\n  id: string;\n  authorName?: string | null;\n  content: string;\n  rating?: number | null;\n  approved: boolean;\n  centerId?: string | null;\n  createdAt: string;\n};\n\nexport default function AdminReviews() {\n  const [reviews, setReviews] = useState<Review[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [filter, setFilter] = useState<'all' | 'pending' | 'approved'>('all');\n  const [toast, setToast] = useState<string | null>(null);\n  const [page, setPage] = useState(1);\n  const [totalCount, setTotalCount] = useState<number | null>(null);\n  const [showNewBanner, setShowNewBanner] = useState(false);\n  const [newUnapprovedCount, setNewUnapprovedCount] = useState(0);\n  const baselineUnapprovedRef = useRef<number | null>(null);\n  const pollRef = useRef<number | null>(null);\n\n  const load = useCallback(async (status: 'all' | 'pending' | 'approved' = filter, pageNum = page) => {\n    setLoading(true);\n    try {\n      const take = 10;\n      const url = `/api/reviews/admin?status=${encodeURIComponent(status)}&limit=${take}&page=${pageNum}`;\n      const res = await fetchWithRefresh(url, { credentials: 'include' });\n      const json = await res.json();\n      setReviews(Array.isArray(json.reviews) ? json.reviews : []);\n      setTotalCount(typeof json.totalCount === 'number' ? json.totalCount : null);\n    } catch (e) {\n      console.error('Failed to load reviews', e);\n      setReviews([]);\n    } finally {\n      setLoading(false);\n    }\n  }, [filter, page]);\n\n  useEffect(() => { void load(filter); }, [filter, load]);\n\n  // Poll for new unapproved reviews and show a small banner when new ones arrive.\n  useEffect(() => {\n    const check = async () => {\n      try {\n        const res = await fetchWithRefresh(`/api/reviews/admin?status=${encodeURIComponent(filter)}`, { credentials: 'include' });\n        if (!res.ok) return;\n        const json = await res.json();\n        const list: Review[] = Array.isArray(json.reviews) ? json.reviews : json;\n        const unapproved = list.filter(r => !r.approved).length;\n        const baseline = baselineUnapprovedRef.current;\n        if (baseline === null) {\n          baselineUnapprovedRef.current = unapproved;\n          return;\n        }\n        if (unapproved > baseline) {\n          setNewUnapprovedCount(unapproved - baseline);\n          setShowNewBanner(true);\n        }\n        // don't update baseline here — baseline updates when admin refreshes / views\n      } catch {\n        // ignore polling errors\n      }\n    };\n\n    // start immediate check after a small delay so initial load can set baseline\n    const start = window.setTimeout(() => { void check(); }, 1500);\n    pollRef.current = window.setInterval(() => { void check(); }, 30_000);\n    return () => {\n      clearTimeout(start);\n      if (pollRef.current != null) clearInterval(pollRef.current);\n    };\n  }, [filter]);\n\n\n  const toggleApprove = async (id: string, approved: boolean) => {\n    try {\n      const res = await fetchWithRefresh(`/api/reviews/${encodeURIComponent(id)}`, { method: 'PATCH', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ approved: !approved }) });\n      if (!res.ok) throw new Error('Failed');\n      const json = await res.json();\n      setReviews(r => r.map(x => x.id === id ? (json.review || x) : x));\n      setToast(!approved ? 'Avis approuvé.' : 'Avis retiré.');\n      window.setTimeout(() => setToast(null), 3000);\n    } catch (e) {\n      console.error(e);\n      alert('Impossible de modifier l\\'avis');\n    }\n  };\n\n  const remove = async (id: string) => {\n    if (!confirm('Supprimer cet avis ?')) return;\n    try {\n      const res = await fetchWithRefresh(`/api/reviews/${encodeURIComponent(id)}`, { method: 'DELETE', credentials: 'include' });\n      if (!res.ok) throw new Error('Failed');\n      setReviews(r => r.filter(x => x.id !== id));\n      setToast('Avis supprimé.');\n      window.setTimeout(() => setToast(null), 3000);\n    } catch (e) {\n      console.error(e);\n      alert('Impossible de supprimer l\\'avis');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 flex flex-col md:flex-row\">\n      <Sidebar />\n      <main className=\"flex-1 flex flex-col items-center py-4 px-2 md:py-8 md:px-4 md:ml-64\">\n        {toast && (\n          <div className=\"fixed right-6 top-6 z-50\">\n            <div className=\"bg-green-600 text-white px-4 py-2 rounded shadow\">{toast}</div>\n          </div>\n        )}\n        <div className=\"w-full max-w-5xl mx-auto\">\n          <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4 w-full\">\n            <div className=\"self-start md:self-auto\">\n              <h1 className=\"text-2xl font-bold\">Gestion des avis</h1>\n            </div>\n            <div className=\"flex-1 text-center min-w-0\">\n              <p className=\"text-sm text-gray-600\">Seuls les administrateurs peuvent approuver ou supprimer les avis.</p>\n            </div>\n            <div className=\"w-24 md:w-32\" />\n          </div>\n\n          {showNewBanner ? (\n            <div className=\"mb-4 p-3 rounded bg-blue-50 border border-blue-100 flex items-center justify-between\">\n              <div className=\"text-sm text-blue-700\">{newUnapprovedCount} nouvel{newUnapprovedCount > 1 ? 's' : ''} avis en attente</div>\n              <div className=\"flex items-center gap-2\">\n                <button onClick={async () => { await load(); baselineUnapprovedRef.current = reviews.filter(r => !r.approved).length; setShowNewBanner(false); }} className=\"px-3 py-1 rounded bg-blue-600 text-white text-sm\">Voir</button>\n                <button onClick={() => { baselineUnapprovedRef.current = reviews.filter(r => !r.approved).length; setShowNewBanner(false); }} className=\"px-3 py-1 rounded bg-transparent border border-gray-200 text-sm\">Ignorer</button>\n              </div>\n            </div>\n          ) : null}\n\n          {loading ? <div>Chargement...</div> : (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <div className=\"text-sm text-gray-600\">Filtrer :</div>\n                <div className=\"flex items-center gap-1\">\n                  <button onClick={() => setFilter('all')} className={`px-3 py-1 rounded text-sm ${filter === 'all' ? 'bg-[#0b5566] text-white' : 'bg-white border'}`}>Tous</button>\n                  <button onClick={() => setFilter('pending')} className={`px-3 py-1 rounded text-sm ${filter === 'pending' ? 'bg-[#0b5566] text-white' : 'bg-white border'}`}>En attente</button>\n                  <button onClick={() => setFilter('approved')} className={`px-3 py-1 rounded text-sm ${filter === 'approved' ? 'bg-[#0b5566] text-white' : 'bg-white border'}`}>Publiés</button>\n                </div>\n              </div>\n              {reviews.length === 0 ? <div className=\"text-gray-500\">Aucun avis.</div> : reviews.map(r => (\n                <div key={r.id} className=\"bg-white p-4 rounded shadow\">\n                  <div className=\"flex justify-between items-start\">\n                    <div>\n                      <div className=\"font-semibold\">{r.authorName || 'Anonyme'}</div>\n                      <div className=\"text-xs text-gray-400\">{new Date(r.createdAt).toLocaleString()}</div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <button onClick={() => toggleApprove(r.id, r.approved)} className={`px-3 py-1 rounded text-sm ${r.approved ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>\n                        {r.approved ? 'Rejeter' : 'Approuver'}\n                      </button>\n                      <button onClick={() => remove(r.id)} className=\"px-3 py-1 rounded bg-red-100 text-red-700 text-sm\">Supprimer</button>\n                    </div>\n                  </div>\n                  <div className=\"mt-3 text-gray-800 whitespace-pre-wrap\">{r.content}</div>\n                  {typeof r.rating === 'number' && <div className=\"mt-2 text-sm text-gray-500\">Note: {r.rating}/5</div>}\n                </div>\n              ))}\n              {/* Pagination controls */}\n              {totalCount !== null && totalCount > 10 && (\n                <div className=\"flex items-center justify-center gap-2 mt-4\">\n                  <button disabled={page === 1} onClick={() => { const p = Math.max(1, page - 1); setPage(p); void load(filter, p); }} className=\"px-3 py-1 border rounded\">Préc.</button>\n                  <div className=\"text-sm text-gray-600\">Page {page} / {Math.ceil((totalCount || 0) / 10)}</div>\n                  <button disabled={page >= Math.ceil((totalCount || 0) / 10)} onClick={() => { const p = page + 1; setPage(p); void load(filter, p); }} className=\"px-3 py-1 border rounded\">Suiv.</button>\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n      </main>\n    </div>\n  );\n}\n"],"names":["AdminReviews","reviews","setReviews","useState","loading","setLoading","filter","setFilter","toast","setToast","page","setPage","totalCount","setTotalCount","showNewBanner","setShowNewBanner","newUnapprovedCount","setNewUnapprovedCount","baselineUnapprovedRef","useRef","pollRef","load","useCallback","status","pageNum","url","json","fetchWithRefresh","e","useEffect","check","res","unapproved","r","baseline","start","toggleApprove","id","approved","x","remove","jsxs","jsx","Sidebar","p"],"mappings":"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"}