import{r as d,b as K,f as F,j as t}from"./index-BlCxgRmJ.js";import{u as G}from"./useI18n-BzDKbdEV.js";const Q=import.meta,$=Q?.env?.VITE_API_URL??"/api";function ee(){const{t:n,locale:h}=G(),[P,U]=d.useState(!1);d.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const e=window.matchMedia("(max-height: 600px) and (orientation: landscape)"),s=()=>U(!!e.matches);return s(),typeof e.addEventListener=="function"?e.addEventListener("change",s):e.addListener(s),window.addEventListener("resize",s),window.addEventListener("orientationchange",s),()=>{try{typeof e.removeEventListener=="function"?e.removeEventListener("change",s):e.removeListener(s)}catch{}window.removeEventListener("resize",s),window.removeEventListener("orientationchange",s)}},[]);const[f,A]=d.useState(new Date().getMonth()+1),[p,I]=d.useState(new Date().getFullYear()),[u,g]=d.useState([]),[S,b]=d.useState(!1),[y,D]=d.useState(""),[E,L]=d.useState(""),[M,N]=d.useState(!1),[O,T]=d.useState(""),{user:j}=K();function v(e){T(e),N(!0)}const z=["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],H=Array.from({length:5},(e,s)=>new Date().getFullYear()-2+s);d.useEffect(()=>{let e=!0;return b(!0),L(""),F(`${$}/payment-history/${p}/${f}`,{credentials:"include"}).then(async s=>{const a=s.headers.get("content-type")||"";if(!s.ok){let r;try{r=await s.clone().text()}catch(i){r=String(i)}throw new Error(`HTTP ${s.status} ${s.statusText} - ${r}`)}if(!a.includes("application/json")){const r=await s.text();throw new Error("Unexpected non-JSON response from API: "+r.slice(0,200))}return s.json()}).then(s=>{e&&g(Array.isArray(s)?s:[])}).catch(s=>{console.error("Failed to fetch payment history",s),e&&g([]),e&&L(String(s.message||s))}).finally(()=>{e&&b(!1)}),()=>{e=!1}},[p,f]);const J=Array.from(new Map(u.filter(e=>e.parent&&e.parent.id).map(e=>[e.parent.id,e.parent])).values()),R=u.filter(e=>!(y&&(!e.parent||e.parent.id!==y))),V=u.reduce((e,s)=>e+(Number(s.total)||0),0),Y=u.length,B=u.filter(e=>(Number(e.total)||0)>0&&!e.paid).length;function W(){const e=[];e.push(["Parent","Email","Phone","Child","Days","Rate","Subtotal","Total"].join(",")),u.forEach(i=>{const l=i.parent?`${i.parent.firstName||""} ${i.parent.lastName||""}`.trim():"",c=i.parent?.email||"",x=i.parent?.phone||"";(i.details||[]).forEach(o=>{e.push([`"${l}"`,`"${c}"`,`"${x}"`,`"${o.childName}"`,String(o.daysPresent),String(o.ratePerDay),String(o.subtotal),String(i.total)].join(","))})});const s=new Blob([e.join(`
`)],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=`payment-history-${p}-${String(f).padStart(2,"0")}.csv`,r.click(),URL.revokeObjectURL(a)}async function _(e,s){try{b(!0);const a=await F(`${$}/payment-history/invoice/${e}`,{credentials:"include"});if(!a.ok){const x=await a.text().catch(()=>"");if(a.status===403){let o=n("payments.errors.invoice_not_ready");if(x&&x.trim().length>0){const w=x.trim();try{const m=JSON.parse(w);if(m&&typeof m=="object")if(typeof m.message=="string"&&m.message.trim())o=m.message.trim();else if(typeof m.error=="string"&&m.error.trim())o=m.error.trim();else{const C=Object.values(m).find(k=>typeof k=="string"&&k.trim());typeof C=="string"&&(o=C.trim())}else w.length<500&&(o=w)}catch{w.length<500&&(o=w)}}v(o);return}throw new Error(`HTTP ${a.status} ${a.statusText} - ${x}`)}if(!(a.headers.get("content-type")||"").includes("application/pdf")){const x=await a.text().catch(()=>"");throw new Error("Unexpected response when fetching invoice: "+x)}const i=await a.blob(),l=URL.createObjectURL(i),c=document.createElement("a");c.href=l,c.download=s||`invoice-${e}.pdf`,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(l)}catch(a){console.error("Invoice download failed",a);const r=l=>{if(!l||typeof l!="object")return!1;const c=l;return"message"in c&&typeof c.message=="string"},i=(()=>{if(!a)return"";if(typeof a=="string")return a;if(r(a))return a.message;try{return JSON.stringify(a)}catch{return String(a)}})();v(i||n("payments.errors.invoice_download"))}finally{b(!1)}}async function q(e,s){g(a=>a.map(r=>r.id===e?{...r,paid:s}:r));try{const a=await fetch(`${$}/payment-history/${e}/paid`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({paid:s})});if(!a.ok)throw new Error("Failed to update");const r=await a.json();r&&r.record&&g(i=>i.map(l=>l.id===e?r.record:l))}catch(a){console.error("Failed to toggle paid",a),g(r=>r.map(i=>i.id===e?{...i,paid:!s}:i)),v("Erreur lors de la mise à jour du statut de paiement.")}}return t.jsx("div",{className:`relative z-0 min-h-screen bg-[#fcfcff] p-4 ${P?"":"md:pl-64"} w-full`,children:t.jsxs("div",{className:"max-w-7xl mx-auto w-full",children:[t.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 w-full",children:t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl md:text-3xl font-extrabold mb-1 tracking-tight",style:{color:"#0b5566"},children:n("page.payments")}),t.jsx("div",{className:"text-base md:text-lg font-medium mb-4 md:mb-6",style:{color:"#08323a"},children:n("page.payments.description")})]})}),t.jsx("div",{className:"bg-white rounded-lg p-4 mb-4 shadow-sm",children:t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-col md:flex-row gap-3 items-start md:items-center",children:[t.jsxs("div",{className:"flex gap-2 items-center flex-wrap justify-center md:justify-start w-full md:w-auto",children:[t.jsx("select",{value:f,onChange:e=>A(Number(e.target.value)),className:"border p-2 rounded w-36",children:z.map((e,s)=>t.jsx("option",{value:s+1,children:e},s))}),t.jsx("select",{value:p,onChange:e=>I(Number(e.target.value)),className:"border p-2 rounded w-36",children:H.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsx("div",{className:"flex flex-1 w-full",children:t.jsxs("select",{value:y,onChange:e=>D(e.target.value),className:"border p-2 rounded w-full md:w-64",children:[t.jsx("option",{value:"",children:n("payments.filter.all_parents")}),J.map((e,s)=>{const a=e?`${e.firstName||""} ${e.lastName||""}`.trim():"—";return t.jsx("option",{value:e?.id||"",children:a},e?.id||s)})]})})]}),t.jsxs("div",{className:"flex flex-col md:flex-row gap-2 md:space-x-2",children:[t.jsx("button",{onClick:async()=>{if(!y){v(n("payments.errors.select_parent"));return}const e=u.find(s=>s.parent&&s.parent.id===y);if(!e){v(n("payments.errors.no_record_parent"));return}await _(e.id,`facture-${p}-${String(f).padStart(2,"0")}-${e.parent?.lastName||e.id}.pdf`)},className:"bg-blue-500 text-white px-4 py-2 rounded w-full md:w-32 text-center",children:n("payments.download_invoice")}),t.jsx("button",{onClick:W,className:"bg-green-500 text-white px-4 py-2 rounded w-full md:w-32 text-center",children:n("payments.export_csv")}),t.jsx("button",{onClick:()=>window.print(),className:"bg-red-500 text-white px-4 py-2 rounded w-full md:w-32 text-center",children:n("payments.print")})]})]})}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4",children:[t.jsxs("div",{className:"bg-white rounded-xl shadow border border-gray-100 p-4",children:[t.jsx("div",{className:"text-sm text-gray-500",children:n("payments.card.month_revenue")}),t.jsx("div",{className:"text-2xl font-bold mt-1",children:new Intl.NumberFormat(h||"fr-FR",{style:"currency",currency:"EUR"}).format(V)})]}),t.jsxs("div",{className:"bg-white rounded-xl shadow border border-gray-100 p-4",children:[t.jsx("div",{className:"text-sm text-gray-500",children:n("payments.card.families_active")}),t.jsx("div",{className:"text-2xl font-bold mt-1",children:Y})]}),t.jsxs("div",{className:"bg-white rounded-xl shadow border border-gray-100 p-4",children:[t.jsx("div",{className:"text-sm text-gray-500",children:n("payments.card.unpaid")}),t.jsx("div",{className:"text-2xl font-bold mt-1",children:B})]})]}),t.jsxs("div",{className:"grid gap-4",children:[M&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>N(!1)}),t.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-desc",className:"relative max-w-md w-full bg-white rounded-lg shadow-lg p-6 mx-4",children:[t.jsx("h3",{id:"modal-title",className:"text-lg font-semibold text-gray-900",children:"Information"}),t.jsx("p",{id:"modal-desc",className:"mt-3 text-sm text-gray-700",children:O}),t.jsx("div",{className:"mt-6 flex justify-end",children:t.jsx("button",{onClick:()=>N(!1),className:"px-4 py-2 bg-green-600 text-white rounded",children:"OK"})})]})]}),E&&t.jsx("div",{className:"bg-red-50 border border-red-100 text-red-700 p-3 rounded",children:E}),S&&t.jsx("div",{children:n("loading")}),!S&&R.length===0&&t.jsx("div",{className:"text-gray-500",children:n("payments.history.empty")}),R.map(e=>t.jsxs("div",{className:"rounded-lg overflow-hidden shadow",children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between p-4 md:p-6 bg-gradient-to-r from-green-50 to-green-100 gap-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center font-bold",children:(e.parent?`${e.parent.firstName||""}`.slice(0,1)+(e.parent?.lastName||"").slice(0,1):"--").toUpperCase()}),t.jsxs("div",{children:[t.jsx("div",{className:"text-lg font-bold text-gray-900",children:e.parent?`${e.parent.firstName||""} ${e.parent.lastName||""}`.trim():n("common.none")}),t.jsxs("div",{className:"text-sm text-gray-500",children:[e.parent?.email??"",e.parent?.phone?` • ${e.parent?.phone}`:""]})]})]}),t.jsx("div",{className:"text-right",children:t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsxs("div",{className:"text-xs text-gray-500",children:[e.invoiceNumber?t.jsx("span",{className:"mr-2 font-medium",children:e.invoiceNumber}):null,e.createdAt?new Date(e.createdAt).toLocaleDateString("fr-FR"):""]}),e.paid?t.jsx("div",{className:"text-sm text-green-700 font-semibold bg-green-100 px-3 py-1 rounded-full",children:n("payments.status.paid")}):t.jsx("div",{className:"text-sm text-gray-500",children:n("payments.status.unpaid")}),j&&(j.role==="admin"||j.role&&j.role.toLowerCase().includes("super"))&&t.jsx("button",{onClick:()=>q(e.id,!e.paid),className:"text-sm px-2 py-1 bg-blue-500 text-white rounded",children:e.paid?n("payments.actions.mark_unpaid"):n("payments.actions.mark_paid")})]})})]}),t.jsxs("div",{className:"px-6 py-4 bg-white border-t",children:[t.jsx("div",{className:"text-sm text-gray-600 font-medium mb-3",children:n("payments.detail.header",{month:new Date(p,f-1).toLocaleString(h||"fr-FR",{month:"long",year:"numeric"})})}),t.jsx("div",{className:"space-y-3",children:Array.isArray(e.details)&&e.details.length>0?e.details.map((s,a)=>t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 flex flex-col md:flex-row md:items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-orange-200 text-orange-700 flex items-center justify-center font-bold",children:(s.childName||"").slice(0,1).toUpperCase()}),t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold text-gray-800",children:s.childName}),t.jsx("div",{className:"text-xs text-gray-400"})]})]}),t.jsxs("div",{className:"text-right text-sm",children:[t.jsxs("div",{className:"text-gray-500",children:[t.jsx("span",{className:"inline-block mr-2",children:"📅"}),s.daysPresent," ",n("payments.days")]}),t.jsxs("div",{className:"text-green-600 font-semibold mt-1",children:[s.daysPresent," × ",new Intl.NumberFormat(h||"fr-FR",{style:"currency",currency:"EUR"}).format(s.ratePerDay)," = ",new Intl.NumberFormat(h||"fr-FR",{style:"currency",currency:"EUR"}).format(s.subtotal)]})]})]},a)):t.jsx("div",{className:"text-gray-500",children:n("payments.no_child_this_month")})})]}),t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between p-4 md:p-6 bg-gradient-to-r from-green-50 to-green-100 gap-3",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-semibold text-gray-800",children:n("payments.family.total_label")}),t.jsx("div",{className:"text-xs text-gray-500",children:Array.isArray(e.details)?n("payments.family.summary",{n:String(e.details.length),days:String(e.details.reduce((s,a)=>s+(a.daysPresent||0),0))}):""})]}),t.jsxs("div",{className:"flex items-center gap-4 flex-col md:flex-row w-full md:w-auto",children:[t.jsx("div",{className:"text-2xl font-extrabold text-green-700",children:new Intl.NumberFormat(h||"fr-FR",{style:"currency",currency:"EUR"}).format(Number(e.total))}),t.jsx("div",{className:"w-full md:w-auto flex justify-center md:justify-end",children:t.jsx("a",{href:"#",onClick:s=>{s.preventDefault(),_(e.id,`facture-${p}-${String(f).padStart(2,"0")}-${e.parent?.lastName||e.id}.pdf`)},className:"px-4 py-2 bg-green-600 text-white rounded text-sm w-full md:w-auto text-center",children:e.invoiceNumber?`${n("payments.download_invoice")} (${e.invoiceNumber})`:n("payments.download_invoice")})})]})]})]},e.id))]})]})})}export{ee as default};
//# sourceMappingURL=PaymentHistory-B8D3rAGz.js.map
